name: Secure Study Blog Generator (DLP & Access Control)

on:
  workflow_dispatch:
  push:
    paths:
      - 'reports/**'

# ğŸ” [ë³´ì•ˆ ë¡œì§ 1] ê¶Œí•œ ìµœì†Œí™”: ì˜¤ì§ ì»¨í…ì¸  ì½ê¸°/ì“°ê¸° ê¶Œí•œë§Œ ë¶€ì—¬
permissions:
  contents: write

jobs:
  secure-document-generation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ğŸ” [ë³´ì•ˆ ë¡œì§ 2] ë¦¬í¬ì§€í† ë¦¬ ê°€ì‹œì„± ê²€ì‚¬ (Publicì¼ ê²½ìš° ì¦‰ì‹œ ì°¨ë‹¨)
      - name: ğŸ›¡ï¸ Security Guardrail - Visibility Check
        run: |
          echo "Checking Repository Visibility..."
          
          # GitHub APIë¥¼ í†µí•´ ë¦¬í¬ì§€í† ë¦¬ ì •ë³´ ì¡°íšŒ
          IS_PRIVATE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }} \
            | jq -r .private)
          
          if [ "$IS_PRIVATE" != "true" ]; then
            echo "ğŸš¨ [CRITICAL ERROR] ë³´ì•ˆ ìœ„ê·œ: ì´ ë¦¬í¬ì§€í† ë¦¬ëŠ” 'Public' ìƒíƒœì…ë‹ˆë‹¤."
            echo "â›” ë¬¸ì„œ ìœ ì¶œ ë°©ì§€ë¥¼ ìœ„í•´ ì›Œí¬í”Œë¡œìš°ë¥¼ ê°•ì œ ì¢…ë£Œí•©ë‹ˆë‹¤."
            echo "ğŸ‘‰ ë¦¬í¬ì§€í† ë¦¬ ì„¤ì •(Settings)ì—ì„œ 'Private'ìœ¼ë¡œ ë³€ê²½í•˜ì‹­ì‹œì˜¤."
            exit 1
          else
            echo "âœ… [SECURE] ë¦¬í¬ì§€í† ë¦¬ê°€ 'Private' ìƒíƒœì„ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì‘ì—…ì„ ì§„í–‰í•©ë‹ˆë‹¤."
          fi

      - name: Generate Secure README.md
        shell: bash
        run: |
          # README.md íŒŒì¼ ìƒì„±
          cat <<EOF > README.md
          # ğŸ›¡ï¸ ì •ë³´ë³´ì•ˆê¸°ì‚¬ ìŠ¤í„°ë”” (Secure Archive)
          
          > ğŸ”’ **ë³´ì•ˆ ë“±ê¸‰:** ëŒ€ì™¸ë¹„ (Private Only)
          > ğŸ“… **ìµœì¢… ì ê²€ì¼:** $(date +'%Y-%m-%d')
          
          ![Security Check](https://img.shields.io/badge/Security-Passed-green?style=for-the-badge&logo=githubactions)
          
          ì´ ë¦¬í¬ì§€í† ë¦¬ëŠ” ì •ë³´ë³´ì•ˆê¸°ì‚¬ í•™ìŠµ ìë£Œë¥¼ ì €ì¥í•˜ë©°, **DLP(Data Loss Prevention)** ë¡œì§ì— ì˜í•´ ë³´í˜¸ë©ë‹ˆë‹¤.
          
          ---
          
          ## ğŸ“š ë³´ì•ˆ í•™ìŠµ ì»¤ë¦¬í˜ëŸ¼ (ì‹œìŠ¤í…œ ë³´ì•ˆ ìƒì„¸)
          
          ### 1ï¸âƒ£ ì‹œìŠ¤í…œ ë³´ì•ˆ (System Security)
          - **ìš´ì˜ì²´ì œ êµ¬ì¡°:** CPU/ë©”ëª¨ë¦¬ ê´€ë¦¬, í”„ë¡œì„¸ìŠ¤ ìŠ¤ì¼€ì¤„ë§, êµì°©ìƒíƒœ(Deadlock)
          - **í´ë¼ì´ì–¸íŠ¸ ë³´ì•ˆ:** ìœˆë„ìš° ë ˆì§€ìŠ¤íŠ¸ë¦¬, ì•…ì„±ì½”ë“œ(ë°”ì´ëŸ¬ìŠ¤/ëœì„¬ì›¨ì–´) ë¶„ì„
          - **ì„œë²„ ë³´ì•ˆ:** ê³„ì • ê´€ë¦¬(/etc/passwd), ê¶Œí•œ ê´€ë¦¬, ì„œë¹„ìŠ¤ ë³´ì•ˆ
          - **ë¡œê·¸ ë¶„ì„:** Syslog, wtmp/utmp, ì¹¨í•´ì‚¬ê³  ëŒ€ì‘
          
          ### 2ï¸âƒ£ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ (Network Security)
          - OSI 7ê³„ì¸µ, TCP/IP, DDoS, ë°©í™”ë²½, IDS/IPS
          
          ### 3ï¸âƒ£ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ (App Security)
          - OWASP Top 10, SQL Injection, DB ì•”í˜¸í™”
          
          ### 4ï¸âƒ£ ì •ë³´ë³´ì•ˆ ì¼ë°˜ (General)
          - CIA 3ìš”ì†Œ, ì•”í˜¸í•™(AES/RSA), ì ‘ê·¼í†µì œ(MAC/DAC/RBAC)
          
          ### 5ï¸âƒ£ ê´€ë¦¬ ë° ë²•ê·œ (Compliance)
          - ISMS-P, ê°œì¸ì •ë³´ë³´í˜¸ë²•, ì •ë³´í†µì‹ ë§ë²•
          
          ---
          
          ## ğŸ“‚ ë³´ì•ˆ ë¦¬í¬íŠ¸ (Secure Reports)
          | ë‚ ì§œ | íŒŒì¼ëª… | ë¬´ê²°ì„± ê²€ì¦ |
          |:---:|:---|:---:|
          EOF
          
          # ë¦¬í¬íŠ¸ ëª©ë¡ ë™ì  ìƒì„±
          if [ -d "reports" ] && ls reports/*.md >/dev/null 2>&1; then
            ls -1t reports/*.md | while read filepath; do
              filename=$(basename "$filepath")
              dateStr=$(echo "$filename" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' || date +'%Y-%m-%d')
              echo "| $dateStr | [$filename]($filepath) | ğŸ”’ Verified |" >> README.md
            done
          else
            echo "| - | ë°ì´í„° ì—†ìŒ | - |" >> README.md
          fi
          
          echo -e "\n> *Generated by Secure Pipeline*" >> README.md

      # ğŸ” [ë³´ì•ˆ ë¡œì§ 3] DLP(ë°ì´í„° ìœ ì¶œ ë°©ì§€) ìŠ¤ìº”
      - name: ğŸ›¡ï¸ Security Guardrail - DLP Scan
        run: |
          echo "ğŸ” DLP ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
          
          # ê²€ì‚¬í•  í‚¤ì›Œë“œ ëª©ë¡ (ì‹¤ìˆ˜ë¡œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ë¯¼ê° ì •ë³´)
          FORBIDDEN_KEYWORDS=("PRIVATE KEY" "AWS_ACCESS_KEY" "password=" "secret_token")
          
          # README.md íŒŒì¼ ê²€ì‚¬
          FOUND_THREAT=false
          for KEYWORD in "${FORBIDDEN_KEYWORDS[@]}"; do
            if grep -q "$KEYWORD" README.md; then
              echo "ğŸš¨ [DLP ALERT] README.md íŒŒì¼ì—ì„œ ë¯¼ê°í•œ í‚¤ì›Œë“œ ë°œê²¬: $KEYWORD"
              FOUND_THREAT=true
            fi
          done
          
          if [ "$FOUND_THREAT" = true ]; then
            echo "â›” ë³´ì•ˆ ì •ì±… ìœ„ë°˜ìœ¼ë¡œ ì¸í•´ ì»¤ë°‹ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤."
            rm README.md # ìœ ì¶œ ë°©ì§€ë¥¼ ìœ„í•´ ìƒì„±ëœ íŒŒì¼ ì¦‰ì‹œ ì‚­ì œ
            exit 1
          else
            echo "âœ… [CLEAN] ë¯¼ê° ì •ë³´ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì•ˆì „í•©ë‹ˆë‹¤."
          fi

      - name: Commit and Push Securely
        run: |
          git config --global user.name "sec-bot"
          git config --global user.email "sec-bot@noreply.github.com"
          
          git add README.md
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ."
          else
            git commit -m "ğŸ”’ Update Secure Study Log (Security Check Passed)"
            git push
          fi
