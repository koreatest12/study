name: Ultimate Study Blog Generator (Fixed & Enhanced)

on:
  workflow_dispatch:
    inputs:
      strict_mode:
        description: 'ë³´ì•ˆ ê°•ì œ ëª¨ë“œ (Publicì¼ ê²½ìš° ì¤‘ë‹¨)'
        required: false
        default: 'false'
  push:
    paths:
      - 'reports/**'

permissions:
  contents: write

jobs:
  update-blog-readme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. [ë³´ì•ˆ] ë¦¬í¬ì§€í† ë¦¬ ê°€ì‹œì„± ê°ì‚¬
      - name: ğŸ›¡ï¸ Security Audit - Visibility
        id: visibility
        run: |
          # API í˜¸ì¶œ ê²°ê³¼ë¥¼ ì‰˜ ë³€ìˆ˜ì— ì €ì¥
          IS_PRIVATE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }} | jq -r .private)
          
          if [ "$IS_PRIVATE" == "false" ]; then
            echo "STATUS=Public" >> $GITHUB_OUTPUT
            echo "BADGE_COLOR=red" >> $GITHUB_OUTPUT
            echo "âš ï¸ Warning: Repository is Public."
            # strict modeê°€ ì¼œì ¸ìˆì„ ë•Œë§Œ ì¢…ë£Œ
            if [ "${{ github.event.inputs.strict_mode }}" == "true" ]; then exit 1; fi
          else
            echo "STATUS=Private" >> $GITHUB_OUTPUT
            echo "BADGE_COLOR=blue" >> $GITHUB_OUTPUT
          fi

      # 2. [ê¸°ëŠ¥] í•™ìŠµ í†µê³„, ë ˆë²¨, í”„ë¡œê·¸ë ˆìŠ¤ ë°” ê³„ì‚°
      - name: ğŸ“Š Calculate Study Stats
        id: stats
        shell: bash
        run: |
          # ë¦¬í¬íŠ¸ ê°œìˆ˜ ì„¸ê¸°
          if [ -d "reports" ]; then
            COUNT=$(ls reports/*.md 2>/dev/null | wc -l)
          else
            COUNT=0
          fi
          echo "REPORT_COUNT=$COUNT" >> $GITHUB_OUTPUT
          
          # ë ˆë²¨ ë° ì¹­í˜¸ ì‚°ì • (ë±ƒì§€ URLì— ê³µë°± ì œê±° ë° ì¸ì½”ë”© ì ìš©)
          if [ "$COUNT" -lt 5 ]; then 
            LEVEL_TEXT="Lv.1_Beginner"
            COLOR="yellow"
            BAR="â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘"
          elif [ "$COUNT" -lt 15 ]; then 
            LEVEL_TEXT="Lv.2_Script_Kiddie"
            COLOR="orange"
            BAR="â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘"
          elif [ "$COUNT" -lt 30 ]; then 
            LEVEL_TEXT="Lv.3_Analyst"
            COLOR="blue"
            BAR="â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘"
          elif [ "$COUNT" -lt 50 ]; then 
            LEVEL_TEXT="Lv.4_White_Hacker"
            COLOR="purple"
            BAR="â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘"
          else 
            LEVEL_TEXT="Lv.5_Master"
            COLOR="red"
            BAR="â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“"
          fi
          
          echo "LEVEL_BADGE=https://img.shields.io/badge/Level-$LEVEL_TEXT-$COLOR?style=for-the-badge" >> $GITHUB_OUTPUT
          echo "PROGRESS_BAR=$BAR" >> $GITHUB_OUTPUT

      # 3. [ê¸°ëŠ¥] ì˜¤ëŠ˜ì˜ ë³´ì•ˆ ìš©ì–´ (ëœë¤ ìƒì„±)
      - name: ğŸ² Generate Daily Security Tip
        id: tip
        shell: bash
        run: |
          # ë°°ì—´ ì„ ì–¸
          TIPS=(
            "Zero Trust: ì•„ë¬´ë„ ì‹ ë¢°í•˜ì§€ ì•Šê³  í•­ìƒ ê²€ì¦í•˜ë¼."
            "CIA Triad: ê¸°ë°€ì„±(Confidentiality), ë¬´ê²°ì„±(Integrity), ê°€ìš©ì„±(Availability)."
            "SQL Injection: ì…ë ¥ê°’ ê²€ì¦ ì‹¤íŒ¨ë¡œ ë°œìƒí•˜ëŠ” DB í•´í‚¹ ê¸°ë²•."
            "Ransomware: ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•˜ê³  ëª¸ê°’ì„ ìš”êµ¬í•˜ëŠ” ì•…ì„±ì½”ë“œ."
            "Social Engineering: ê¸°ìˆ ì´ ì•„ë‹Œ ì‚¬ëŒì˜ ì‹¬ë¦¬ë¥¼ ì´ìš©í•´ ì •ë³´ë¥¼ íƒˆì·¨í•˜ëŠ” ê¸°ë²•."
            "DDoS: ë¶„ì‚°ëœ ì¢€ë¹„ PCë¡œ ì„œë¹„ìŠ¤ ê°€ìš©ì„±ì„ ë§ˆë¹„ì‹œí‚¤ëŠ” ê³µê²©."
            "APT: ì§€ëŠ¥í˜• ì§€ì† ìœ„í˜‘, íŠ¹ì • ëª©í‘œë¥¼ ì •í•´ ì¥ê¸°ê°„ ê³µê²©í•˜ëŠ” ê¸°ë²•."
            "Mitre ATT&CK: í•´ì»¤ì˜ ê³µê²© ì „ìˆ ê³¼ ê¸°ìˆ ì„ ë¶„ë¥˜í•œ ì§€ì‹ ë² ì´ìŠ¤."
          )
          # ëœë¤ ì„ íƒ
          RANDOM_TIP=${TIPS[$RANDOM % ${#TIPS[@]}]}
          echo "TODAY_TIP=$RANDOM_TIP" >> $GITHUB_OUTPUT

      # 4. [ë©”ì¸] README.md ìƒì„± (ì—ëŸ¬ ìˆ˜ì •ë¨)
      - name: ğŸ“ Generate Dynamic README
        shell: bash
        run: |
          # 1. ë³€ìˆ˜ ì¤€ë¹„ (GitHub Actions ë¬¸ë²•ì„ ì‰˜ ë³€ìˆ˜ë¡œ ë³€í™˜)
          VISIBILITY_STATUS="${{ steps.visibility.outputs.STATUS }}"
          VISIBILITY_COLOR="${{ steps.visibility.outputs.BADGE_COLOR }}"
          TODAY_DATE=$(date +'%Y--%m--%d')
          
          REPORT_COUNT="${{ steps.stats.outputs.REPORT_COUNT }}"
          LEVEL_BADGE="${{ steps.stats.outputs.LEVEL_BADGE }}"
          PROGRESS_BAR="${{ steps.stats.outputs.PROGRESS_BAR }}"
          TODAY_TIP="${{ steps.tip.outputs.TODAY_TIP }}"
          
          # ë³´ì•ˆ ë±ƒì§€ URL ì¡°ë¦½
          SECURITY_BADGE="https://img.shields.io/badge/Security-$VISIBILITY_STATUS-$VISIBILITY_COLOR?style=for-the-badge"
          
          # 2. README íŒŒì¼ ì‘ì„± (ì´ì œ ìˆœìˆ˜ ì‰˜ ë³€ìˆ˜ë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ì—ëŸ¬ ì—†ìŒ)
          cat <<EOF > README.md
          # ğŸ›¡ï¸ ì •ë³´ë³´ì•ˆê¸°ì‚¬ ìŠ¤í„°ë”” (Information Security Engineer)
          
          ![Status](https://img.shields.io/badge/Status-Active-success?style=for-the-badge)
          ![Security Audit]($SECURITY_BADGE)
          ![Last Update](https://img.shields.io/badge/Updated-$TODAY_DATE-lightgrey?style=for-the-badge)
          ![Level]($LEVEL_BADGE)
          
          > ğŸ’¡ **Today's Security Term:**
          > **$TODAY_TIP**
          
          ---
          
          ## ğŸ“‚ í•™ìŠµ í˜„í™© (Study Dashboard)
          
          **Current Level Progress:**
          \`$PROGRESS_BAR\` (Total Reports: **$REPORT_COUNT**)
          
          
          ### ğŸ“š í•™ìŠµ ì»¤ë¦¬í˜ëŸ¼ (ìƒì„¸ ë³´ê¸°)
          <details>
          <summary>ğŸ‘† **1. ì‹œìŠ¤í…œ ë³´ì•ˆ (System Security) - í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸°**</summary>
          
          - **ìš´ì˜ì²´ì œ êµ¬ì¡°:** CPU/ë©”ëª¨ë¦¬ ê´€ë¦¬, í”„ë¡œì„¸ìŠ¤ ìŠ¤ì¼€ì¤„ë§, êµì°©ìƒíƒœ(Deadlock)
          - **í´ë¼ì´ì–¸íŠ¸ ë³´ì•ˆ:** ìœˆë„ìš° ë ˆì§€ìŠ¤íŠ¸ë¦¬, ì•…ì„±ì½”ë“œ(ë°”ì´ëŸ¬ìŠ¤/ëœì„¬ì›¨ì–´) ë¶„ì„ ë° ëŒ€ì‘
          - **ì„œë²„ ë³´ì•ˆ:** ê³„ì • ê´€ë¦¬(/etc/passwd), ê¶Œí•œ ê´€ë¦¬(chmod), ì„œë¹„ìŠ¤ ë³´ì•ˆ
          - **ë¡œê·¸ ë¶„ì„:** Syslog, wtmp/utmp, Windows Event Log, ì¹¨í•´ì‚¬ê³  ëŒ€ì‘
          </details>
          
          <details>
          <summary>ğŸ‘† **2. ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ (Network Security)**</summary>
          
          - **ë„¤íŠ¸ì›Œí¬ ì¼ë°˜:** OSI 7ê³„ì¸µ, TCP/IP í—¤ë” êµ¬ì¡°
          - **ê³µê²© ê¸°ë²•:** DoS/DDoS, Spoofing, Sniffing, Session Hijacking
          - **ë³´ì•ˆ ì¥ë¹„:** ë°©í™”ë²½, IDS/IPS, VPN, NAC
          - **ë¬´ì„  ë³´ì•ˆ:** WEP, WPA/WPA2, 802.1x
          </details>
          
          <details>
          <summary>ğŸ‘† **3. ì–´í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ (App Security)**</summary>
          
          - **ì›¹ ë³´ì•ˆ:** OWASP Top 10 (SQL Injection, XSS, CSRF)
          - **DB ë³´ì•ˆ:** ì ‘ê·¼í†µì œ, ë¬´ê²°ì„±, ì•”í˜¸í™”
          - **ì „ììƒê±°ë˜:** SET, SSL/TLS í”„ë¡œí† ì½œ
          </details>
          
          <details>
          <summary>ğŸ‘† **4. ì •ë³´ë³´ì•ˆ ì¼ë°˜ (General)**</summary>
          
          - **ë³´ì•ˆ ê°œìš”:** ê¸°ë°€ì„±, ë¬´ê²°ì„±, ê°€ìš©ì„± (CIA)
          - **ì•”í˜¸í•™:** ëŒ€ì¹­í‚¤/ê³µê°œí‚¤, í•´ì‹œí•¨ìˆ˜, ì „ìì„œëª…, PKI
          - **ì ‘ê·¼ í†µì œ:** MAC, DAC, RBAC, ì‹ë³„/ì¸ì¦/ì¸ê°€
          </details>
          
          <details>
          <summary>ğŸ‘† **5. ê´€ë¦¬ ë° ë²•ê·œ (Compliance)**</summary>
          
          - **ê´€ë¦¬ì²´ê³„:** ISMS-P, ìœ„í—˜ ê´€ë¦¬(Risk Management), BCP/DRP
          - **ë²•ê·œ:** ì •ë³´í†µì‹ ë§ë²•, ê°œì¸ì •ë³´ë³´í˜¸ë²•, ì •ë³´í†µì‹ ê¸°ë°˜ë³´í˜¸ë²•
          </details>
          
          ---
          
          ## ğŸ“‘ í•™ìŠµ ë¦¬í¬íŠ¸ ëª©ë¡ (Reports)
          | ë‚ ì§œ | ë¦¬í¬íŠ¸ ì œëª© | ìƒíƒœ |
          |:---:|:---|:---:|
          EOF
          
          # 3. ë¦¬í¬íŠ¸ ëª©ë¡ ë™ì  ìƒì„± (ì•ˆì •ì„± ê°•í™”)
          if [ -d "reports" ] && ls reports/*.md >/dev/null 2>&1; then
            ls -1t reports/*.md | while read filepath; do
              filename=$(basename "$filepath")
              dateStr=$(echo "$filename" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' || date +'%Y-%m-%d')
              echo "| $dateStr | [$filename]($filepath) | âœ… Verified |" >> README.md
            done
          else
            echo "| - | ğŸ“ ì‘ì„±ëœ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. | - |" >> README.md
          fi
          
          echo -e "\n---\n*Auto-generated by GitHub Actions (Ultimate Edition)*" >> README.md

      # 5. [ë³´ì•ˆ] DLP ìŠ¤ìº” ë° ë§ˆìŠ¤í‚¹
      - name: ğŸ›¡ï¸ Security Guardrail - DLP Masking
        run: |
          KEYWORDS=("PRIVATE KEY" "AWS_ACCESS_KEY" "password=" "secret")
          for KEY in "${KEYWORDS[@]}"; do
            sed -i "s/$KEY/[REDACTED-SECRET]/g" README.md
          done

      - name: Commit and Push
        run: |
          git config --global user.name "security-bot"
          git config --global user.email "bot@noreply.github.com"
          git add README.md
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update Blog: Level ${{ steps.stats.outputs.REPORT_COUNT }} (Safe Mode)"
            git push
          fi
