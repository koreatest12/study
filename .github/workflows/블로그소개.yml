name: Daily Auto Study Generator

on:
  schedule:
    - cron: '0 0 * * *' # 매일 자정 (UTC 기준 00:00, 한국 시간 오전 9:00) 실행
  workflow_dispatch: # 수동 실행 가능

permissions:
  contents: write

jobs:
  generate-daily-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Date
        shell: bash
        run: echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Create Reports Directory
        run: mkdir -p reports

      - name: Generate Study Content
        shell: bash
        run: |
          # 1. 학습 주제 데이터베이스 (기존 워크플로우의 커리큘럼 기반)
          # 배열 인덱스: 0=시스템, 1=네트워크, 2=어플리케이션, 3=일반, 4=관리/법규
          
          SUBJECTS=("시스템 보안" "네트워크 보안" "어플리케이션 보안" "정보보안 일반" "관리 및 법규")
          
          # 각 주제별 세부 토픽 리스트
          TOPICS_0=("운영체제 구조 및 커널" "프로세스 스케줄링 알고리즘" "교착상태(Deadlock) 해결법" "Unix 파일 시스템(Inode)" "Windows 인증 구조(LSA/SAM)" "악성코드 분석 기초" "로그 분석(Syslog/EventLog)")
          TOPICS_1=("OSI 7계층과 TCP/IP" "TCP 3-way Handshake" "DoS 및 DDoS 공격 기법" "패킷 스니핑과 스푸핑" "IPSec VPN 동작 원리" "침입탐지시스템(IDS) vs IPS" "무선 LAN 보안(WPA2/WPA3)")
          TOPICS_2=("OWASP Top 10 취약점" "SQL Injection 공격 및 방어" "XSS(Cross Site Scripting)" "CSRF 공격 원리" "파일 업로드 취약점" "데이터베이스 암호화 기술" "SSL/TLS 핸드셰이크 과정")
          TOPICS_3=("보안의 3요소(CIA)" "대칭키 vs 공개키 암호화" "해시 함수와 무결성" "전자서명과 PKI 구조" "접근통제 모델(MAC/DAC/RBAC)" "사용자 인증 기술(Biometrics/OTP)")
          TOPICS_4=("ISMS-P 인증 기준" "위험 관리(Risk Management)" "업무연속성계획(BCP/DRP)" "개인정보보호법 주요 내용" "정보통신망법 이해" "침해사고 대응 절차")

          # 2. 랜덤 주제 선정
          RANDOM_SUB_IDX=$((RANDOM % 5))
          SELECTED_SUBJECT="${SUBJECTS[$RANDOM_SUB_IDX]}"
          
          # 선택된 주제에 맞는 토픽 배열 선택 (간접 참조)
          eval "TARGET_TOPICS=(\"\${TOPICS_${RANDOM_SUB_IDX}[@]}\")"
          RANDOM_TOPIC_IDX=$((RANDOM % ${#TARGET_TOPICS[@]}))
          SELECTED_TOPIC="${TARGET_TOPICS[$RANDOM_TOPIC_IDX]}"
          
          # 파일명 생성 (공백을 언더바_로 치환)
          SAFE_TOPIC_NAME=$(echo "$SELECTED_TOPIC" | sed 's/ /_/g' | sed 's/[^a-zA-Z0-9가-힣_.-]//g')
          FILE_NAME="reports/${TODAY}_${SAFE_TOPIC_NAME}.md"
          
          echo "🎯 오늘의 학습 목표: [$SELECTED_SUBJECT] $SELECTED_TOPIC"
          
          # 3. 마크다운 보고서 자동 생성
          cat <<EOF > "$FILE_NAME"
          # 📘 $SELECTED_SUBJECT 학습 보고서: $SELECTED_TOPIC
          
          **학습일:** ${TODAY}
          **작성자:** Auto Study Bot
          
          ---
          
          ## 1. 개요 (Overview)
          오늘의 학습 주제는 **'$SELECTED_SUBJECT'** 영역의 핵심 내용인 **'$SELECTED_TOPIC'**입니다.
          정보보안기사 필기 및 실기 시험에서 중요하게 다뤄지는 항목입니다.
          
          ## 2. 핵심 요약 (Core Concepts)
          *이 내용은 자동 생성된 템플릿입니다. 실제 학습 내용을 아래에 채워넣으세요.*
          
          ### 2.1 개념 정의
          - **$SELECTED_TOPIC**란 무엇인가?
          - 주요 특징 및 동작 원리
          
          ### 2.2 주요 키워드
          - [ ] 핵심 용어 1
          - [ ] 핵심 용어 2
          - [ ] 핵심 용어 3
          
          ## 3. 보안 위협 및 대응 방안
          | 구분 | 내용 |
          |:---:|:---|
          | **보안 위협** | 해당 기술과 관련된 취약점 또는 공격 기법 |
          | **대응 방안** | 관리적/기술적/물리적 보안 대책 |
          
          ---
          
          ## 4. 결론 및 추가 학습 (Reference)
          - 관련 법규 또는 표준:
          - 추가로 공부할 연관 주제:
          
          > *This report was automatically initiated by GitHub Actions based on the study curriculum.*
          EOF
          
          echo "✅ 파일 생성 완료: $FILE_NAME"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add reports/
          # 변경사항이 있을 경우에만 커밋
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto-Generate Study Report: $SELECTED_TOPIC (${TODAY})"
            git push
          fi
