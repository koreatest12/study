name: Daily Auto Study Generator (Fixed & Expanded)

on:
  schedule:
    - cron: '0 0 * * *' # 매일 자정 (한국 시간 오전 9시)
  workflow_dispatch: # 수동 실행

permissions:
  contents: write

jobs:
  generate-daily-report:
    runs-on: ubuntu-latest
    # 🌍 [중요] 한국 시간 및 언어셋 강제 설정 (에러 해결 핵심)
    env:
      TZ: 'Asia/Seoul'
      LANG: 'ko_KR.UTF-8'
      LC_ALL: 'ko_KR.UTF-8'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Environment & Directory
        run: |
          # 현재 날짜 (KST 기준)
          echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          mkdir -p reports

      - name: Generate Study Content
        shell: bash
        run: |
          # ==========================================================
          # 📚 정보보안기사 학습 데이터베이스 (Massive Update)
          # ==========================================================
          
          SUBJECTS=("시스템 보안" "네트워크 보안" "어플리케이션 보안" "정보보안 일반" "관리 및 법규")
          
          # 1. 시스템 보안
          TOPICS_0=(
            "운영체제 커널과 쉘의 차이" "프로세스 스케줄링(RR, SRT, MLQ)" "교착상태(Deadlock) 4대 조건" 
            "메모리 관리 기법(Paging vs Segmentation)" "가상 메모리와 페이지 교체 알고리즘" 
            "Unix 파일 시스템(Inode, SuperBlock)" "SetUID와 SetGID 보안 취약점" 
            "Windows 레지스트리 분석" "시스템 로그 분석(wtmp, utmp, btmp)" "랜섬웨어 동작 원리 및 대응"
            "레이스 컨디션(Race Condition) 공격" "버퍼 오버플로우(Stack, Heap) 기초"
          )
          
          # 2. 네트워크 보안
          TOPICS_1=(
            "OSI 7계층 모델 상세 분석" "TCP 3-way 및 4-way Handshake" "ARP Spoofing 공격 원리" 
            "DoS(Syn Flooding)와 DDoS 차이" "DRDoS(반사 공격) 원리" "IPSec VPN(AH, ESP, IKE)" 
            "SSL TLS 핸드셰이크 상세 과정" "방화벽(Firewall) 유형 및 한계" 
            "IDS(탐지)와 IPS(차단)의 차이" "무선 보안(WPA2 vs WPA3)" "DNS Spoofing과 Pharming"
            "허니팟(Honeypot) 구축 및 활용"
          )
          
          # 3. 어플리케이션 보안
          TOPICS_2=(
            "OWASP Top 10 최신 트렌드" "SQL Injection(Error, Blind, Union)" "XSS(Reflected, Stored, DOM)" 
            "CSRF 공격과 토큰 방어" "SSRF(Server Side Request Forgery)" "파일 업로드 취약점 및 WebShell" 
            "디렉토리 트래버설(Path Traversal)" "데이터베이스 암호화 방식(API, Plug-in)" 
            "전자상거래 보안(SET, SSL)" "웹 방화벽(WAF)의 역할"
          )
          
          # 4. 정보보안 일반
          TOPICS_3=(
            "보안의 3요소(CIA)와 AAA" "대칭키 암호화(AES, DES, SEED)" "공개키 암호화(RSA, ECC)" 
            "해시 함수(SHA-256)와 무결성 검증" "전자서명(Digital Signature) 원리" "PKI(공개키 기반 구조) 구성요소" 
            "접근통제 모델(MAC, DAC, RBAC)" "사용자 인증(Biometrics, OTP, Kerberos)" 
            "스테가노그래피(Steganography)" "블록체인과 보안"
          )
          
          # 5. 관리 및 법규
          TOPICS_4=(
            "ISMS-P 인증 심사 기준" "위험 관리(Risk Management) 방법론" "BCP(업무연속성)와 DRP(재해복구)" 
            "개인정보보호법 주요 벌칙 규정" "정보통신망법과 정보통신기반보호법" "CC 인증(Common Criteria)" 
            "침해사고 대응 7단계 절차" "디지털 포렌식 증거 수집 원칙" "GDPR 주요 내용"
          )

          # ==========================================================
          # 🎲 랜덤 주제 및 토픽 선정 로직
          # ==========================================================
          
          # 1. 주제 랜덤 선택 (0~4)
          RAND_SUB=$((RANDOM % 5))
          SELECTED_SUBJECT="${SUBJECTS[$RAND_SUB]}"
          
          # 2. 해당 주제의 토픽 배열 가져오기 (간접 참조)
          eval "TARGET_ARR=(\"\${TOPICS_${RAND_SUB}[@]}\")"
          
          # 3. 토픽 랜덤 선택
          RAND_TOPIC=$((RANDOM % ${#TARGET_ARR[@]}))
          SELECTED_TOPIC="${TARGET_ARR[$RAND_TOPIC]}"
          
          # ==========================================================
          # 🛠️ [에러 해결] 안전한 파일명 생성 로직 (sed 제거)
          # ==========================================================
          
          # 공백만 언더바(_)로 변경. 한글은 그대로 유지 (Linux 파일시스템은 한글 지원함)
          # sed의 범위 지정 에러를 피하기 위해 단순 치환만 수행
          SAFE_TOPIC_NAME="${SELECTED_TOPIC// /_}"
          
          # 파일명 최종 조합 (날짜_토픽.md)
          FILE_NAME="reports/${TODAY}_${SAFE_TOPIC_NAME}.md"
          
          echo "🎯 Selected: [$SELECTED_SUBJECT] $SELECTED_TOPIC"
          echo "📂 File Path: $FILE_NAME"
          
          # ==========================================================
          # 📝 마크다운 보고서 내용 작성
          # ==========================================================
          
          cat <<EOF > "$FILE_NAME"
          # 📘 $SELECTED_SUBJECT 학습: $SELECTED_TOPIC
          
          **학습일:** ${TODAY}
          **주제:** $SELECTED_SUBJECT
          
          ---
          
          ## 1. 개요 (Overview)
          **$SELECTED_TOPIC**은(는) 정보보안기사 시험의 **$SELECTED_SUBJECT** 과목에서 매우 중요한 비중을 차지하는 핵심 개념입니다.
          
          ## 2. 핵심 학습 내용 (Key Concepts)
          *(이 문서는 GitHub Actions에 의해 매일 자동으로 생성되는 학습 템플릿입니다. 실제 공부 내용을 채워넣으세요.)*
          
          ### 2.1 개념 및 정의
          - 정의:
          - 필요성:
          
          ### 2.2 동작 원리 / 주요 특징
          1. 
          2. 
          3. 
          
          ## 3. 보안 위협 및 대응 (Threats & Countermeasures)
          | 위협 요소 | 대응 방안 |
          |:---:|:---|
          | (예시) 취약점 악용 | 패치 관리, 입력값 검증 |
          | (예시) 권한 탈취 | 접근 통제 강화, 2FA 적용 |
          
          ---
          
          ## 4. 참고 자료 및 기출 포인트
          - **기출 빈도:** ⭐⭐⭐⭐⭐
          - **관련 키워드:**
          
          > 🤖 *Auto-generated by Daily Study Bot*
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "study-bot"
          git config --global user.email "study-bot@noreply.github.com"
          
          git add reports/
          
          # 변경사항 확인 및 커밋
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "📚 Daily Study: $SELECTED_TOPIC ($TODAY)"
            git push
          fi
