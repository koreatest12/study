name: Secure Study Blog Generator (Audit Mode)

on:
  workflow_dispatch:
    inputs:
      strict_mode:
        description: 'ë³´ì•ˆ ê°•ì œ ëª¨ë“œ (Publicì¼ ê²½ìš° ì‹¤í–‰ ì°¨ë‹¨)'
        required: false
        default: 'false' # falseë¡œ ì„¤ì •í•˜ì—¬ ì—ëŸ¬ ì—†ì´ ì‹¤í–‰ë˜ë„ë¡ í•¨
  push:
    paths:
      - 'reports/**'

permissions:
  contents: write

jobs:
  secure-document-generation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ğŸ” [ë³´ì•ˆ ë¡œì§ 1] ë¦¬í¬ì§€í† ë¦¬ ê°€ì‹œì„± ê°ì‚¬ (Audit)
      - name: ğŸ›¡ï¸ Security Guardrail - Visibility Audit
        id: visibility_check
        run: |
          echo "ğŸ” Repository Visibility Check..."
          
          IS_PRIVATE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }} \
            | jq -r .private)
          
          if [ "$IS_PRIVATE" != "true" ]; then
            echo "âš ï¸ [WARNING] ë¦¬í¬ì§€í† ë¦¬ê°€ 'Public' ìƒíƒœì…ë‹ˆë‹¤."
            echo "status=public" >> $GITHUB_OUTPUT
            
            # ì…ë ¥ë°›ì€ ëª¨ë“œê°€ strict(ê°•ì œ)ì¼ ê²½ìš°ì—ë§Œ ì¢…ë£Œ
            if [ "${{ github.event.inputs.strict_mode }}" == "true" ]; then
              echo "â›” Strict Modeê°€ ì¼œì ¸ ìˆì–´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              exit 1
            else
              echo "âœ… Audit Mode: ê²½ê³ ë¥¼ ê¸°ë¡í•˜ê³  ì‘ì—…ì„ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."
            fi
          else
            echo "âœ… [SECURE] ë¦¬í¬ì§€í† ë¦¬ê°€ 'Private' ìƒíƒœì…ë‹ˆë‹¤."
            echo "status=private" >> $GITHUB_OUTPUT
          fi

      - name: Generate Secure README.md
        shell: bash
        run: |
          # README.md ë‚´ìš© ì‘ì„±
          cat <<EOF > README.md
          # ğŸ›¡ï¸ ì •ë³´ë³´ì•ˆê¸°ì‚¬ ìŠ¤í„°ë”” (Information Security Engineer)
          
          > ğŸ”’ **Security Status:** Verified
          > ğŸ“… **Last Update:** $(date +'%Y-%m-%d')
          
          ![Study Status](https://img.shields.io/badge/Study-Active-success?style=for-the-badge&logo=github)
          ![Security Audit](https://img.shields.io/badge/Security-Audited-blue?style=for-the-badge&logo=githubactions)
          
          ì´ ë¦¬í¬ì§€í† ë¦¬ëŠ” ì •ë³´ë³´ì•ˆê¸°ì‚¬ ìê²©ì¦ í•™ìŠµ ë‚´ìš©ì„ ì •ë¦¬í•˜ëŠ” ê³µê°„ì…ë‹ˆë‹¤.
          ìë™í™”ëœ ì›Œí¬í”Œë¡œìš°ë¥¼ í†µí•´ ë¬¸ì„œë¥¼ ìƒì„±í•˜ê³  ë³´ì•ˆ ê°ì‚¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
          
          ---
          
          ## ğŸ“š í•µì‹¬ í•™ìŠµ ì»¤ë¦¬í˜ëŸ¼
          
          ### 1ï¸âƒ£ ì‹œìŠ¤í…œ ë³´ì•ˆ (System Security)
          - **ìš´ì˜ì²´ì œ:** CPU ìŠ¤ì¼€ì¤„ë§, ë©”ëª¨ë¦¬ ê´€ë¦¬, êµì°©ìƒíƒœ, ê°€ìƒí™” ê¸°ìˆ 
          - **í´ë¼ì´ì–¸íŠ¸ ë³´ì•ˆ:** ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¶„ì„, ì•…ì„±ì½”ë“œ(ëœì„¬ì›¨ì–´/APT) ëŒ€ì‘
          - **ì„œë²„ ë³´ì•ˆ:** ê³„ì •/ê¶Œí•œ ê´€ë¦¬, ì ‘ê·¼ì œì–´(MAC/DAC/RBAC)
          - **ë¡œê·¸ ë¶„ì„:** Windows Event Log, Linux Syslog/Auditd
          
          ### 2ï¸âƒ£ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ (Network Security)
          - OSI 7 Layer, TCP/IP, VPN, ë°©í™”ë²½, IPS/IDS
          
          ### 3ï¸âƒ£ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ (App Security)
          - OWASP Top 10, Secure Coding, DB ì•”í˜¸í™”
          
          ### 4ï¸âƒ£ ì •ë³´ë³´ì•ˆ ì¼ë°˜ (General)
          - CIA, ì•”í˜¸í•™(ëŒ€ì¹­í‚¤/ë¹„ëŒ€ì¹­í‚¤/í•´ì‹œ), ì „ìì„œëª…
          
          ### 5ï¸âƒ£ ê´€ë¦¬ ë° ë²•ê·œ (Compliance)
          - ISMS-P, ê°œì¸ì •ë³´ë³´í˜¸ë²•, ì •ë³´í†µì‹ ê¸°ë°˜ë³´í˜¸ë²•
          
          ---
          
          ## ğŸ“‚ í•™ìŠµ ë¦¬í¬íŠ¸ (Reports)
          | ë‚ ì§œ | íŒŒì¼ëª… | ìƒíƒœ |
          |:---:|:---|:---:|
          EOF
          
          # ë¦¬í¬íŠ¸ íŒŒì¼ ëª©ë¡ ìƒì„± (ì—ëŸ¬ ë°©ì§€ ë¡œì§ í¬í•¨)
          if [ -d "reports" ] && ls reports/*.md >/dev/null 2>&1; then
            ls -1t reports/*.md | while read filepath; do
              filename=$(basename "$filepath")
              dateStr=$(echo "$filename" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' || date +'%Y-%m-%d')
              echo "| $dateStr | [$filename]($filepath) | âœ… ìƒì„±ë¨ |" >> README.md
            done
          else
            echo "| - | ë“±ë¡ëœ ë¦¬í¬íŠ¸ ì—†ìŒ | - |" >> README.md
          fi
          
          echo -e "\n> *This document is automatically managed by Secure GitHub Actions.*" >> README.md

      # ğŸ” [ë³´ì•ˆ ë¡œì§ 2] DLP(ì •ë³´ ìœ ì¶œ ë°©ì§€) ìŠ¤ìº” ë° ë§ˆìŠ¤í‚¹
      - name: ğŸ›¡ï¸ Security Guardrail - DLP Scan & Masking
        id: dlp_scan
        run: |
          echo "ğŸ” ë¯¼ê° ì •ë³´ ìŠ¤ìº” ì¤‘..."
          
          # ë¯¼ê° í‚¤ì›Œë“œ ì •ì˜
          KEYWORDS=("PRIVATE KEY" "AWS_ACCESS_KEY" "password=" "secret_token")
          DETECTED=false
          
          for KEYWORD in "${KEYWORDS[@]}"; do
            if grep -q "$KEYWORD" README.md; then
              echo "âš ï¸ ë¯¼ê° í‚¤ì›Œë“œ ë°œê²¬: $KEYWORD -> [REDACTED] ì²˜ë¦¬í•©ë‹ˆë‹¤."
              # sed ëª…ë ¹ì–´ë¡œ ë¯¼ê° í‚¤ì›Œë“œë¥¼ [REDACTED]ë¡œ ì¹˜í™˜ (ë®ì–´ì“°ê¸°)
              sed -i "s/$KEYWORD/[REDACTED]/g" README.md
              DETECTED=true
            fi
          done
          
          if [ "$DETECTED" = true ]; then
             echo "result=masked" >> $GITHUB_OUTPUT
             echo "âœ… ë¯¼ê° ì •ë³´ë¥¼ ë§ˆìŠ¤í‚¹ ì²˜ë¦¬í•˜ê³  ì§„í–‰í•©ë‹ˆë‹¤."
          else
             echo "result=clean" >> $GITHUB_OUTPUT
             echo "âœ… ë°œê²¬ëœ ë¯¼ê° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

      # ğŸ“Š [ê¸°ëŠ¥ ì¶”ê°€] GitHub Actions ìš”ì•½ ë¦¬í¬íŠ¸ ìƒì„±
      - name: ğŸ“Š Create Security Job Summary
        if: always()
        run: |
          echo "## ğŸ›¡ï¸ Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê²°ê³¼ | ë¹„ê³  |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.visibility_check.outputs.status }}" == "public" ]; then
            echo "| **Repository Visibility** | âš ï¸ Public | ì™¸ë¶€ ê³µê°œ ìƒíƒœ (Audit Mode) |" >> $GITHUB_STEP_SUMMARY
          else
             echo "| **Repository Visibility** | ğŸ”’ Private | ì•ˆì „í•¨ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.dlp_scan.outputs.result }}" == "masked" ]; then
             echo "| **DLP Scan** | âš ï¸ Masked | ë¯¼ê° ì •ë³´ ê°€ë¦¼ ì²˜ë¦¬ë¨ |" >> $GITHUB_STEP_SUMMARY
          else
             echo "| **DLP Scan** | âœ… Clean | íŠ¹ì´ì‚¬í•­ ì—†ìŒ |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "sec-bot"
          git config --global user.email "sec-bot@noreply.github.com"
          
          git add README.md
          if git diff --staged --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          else
            git commit -m "Update Study Log (Security Audit: ${{ steps.visibility_check.outputs.status }})"
            git push
          fi
