name: Ultimate Study Blog Generator

on:
  workflow_dispatch:
    inputs:
      strict_mode:
        description: 'ë³´ì•ˆ ê°•ì œ ëª¨ë“œ (Publicì¼ ê²½ìš° ì¤‘ë‹¨)'
        required: false
        default: 'false'
  push:
    paths:
      - 'reports/**' # ë¦¬í¬íŠ¸ê°€ ì¶”ê°€ë˜ë©´ ìë™ìœ¼ë¡œ ë¸”ë¡œê·¸ ê°±ì‹ 

permissions:
  contents: write

jobs:
  update-blog-readme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. [ë³´ì•ˆ] ë¦¬í¬ì§€í† ë¦¬ ê°€ì‹œì„± ê°ì‚¬
      - name: ğŸ›¡ï¸ Security Audit - Visibility
        id: visibility
        run: |
          IS_PRIVATE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }} | jq -r .private)
          
          if [ "$IS_PRIVATE" == "false" ]; then
            echo "STATUS=Public (Warning)" >> $GITHUB_OUTPUT
            echo "âš ï¸ Warning: Repository is Public."
            if [ "${{ github.event.inputs.strict_mode }}" == "true" ]; then exit 1; fi
          else
            echo "STATUS=Private (Secure)" >> $GITHUB_OUTPUT
          fi

      # 2. [ê¸°ëŠ¥] í•™ìŠµ í†µê³„ ë° ë ˆë²¨ ê³„ì‚°
      - name: ğŸ“Š Calculate Study Stats
        id: stats
        shell: bash
        run: |
          if [ -d "reports" ]; then
            COUNT=$(ls reports/*.md 2>/dev/null | wc -l)
          else
            COUNT=0
          fi
          
          echo "REPORT_COUNT=$COUNT" >> $GITHUB_OUTPUT
          
          # ë ˆë²¨ ì‚°ì • ë¡œì§
          if [ "$COUNT" -lt 5 ]; then LEVEL="Lv.1 ë³´ì•ˆ ì…ë¬¸ì"; COLOR="yellow";
          elif [ "$COUNT" -lt 15 ]; then LEVEL="Lv.2 ìŠ¤í¬ë¦½íŠ¸ í‚¤ë””"; COLOR="orange";
          elif [ "$COUNT" -lt 30 ]; then LEVEL="Lv.3 ë³´ì•ˆ ë¶„ì„ê°€"; COLOR="blue";
          elif [ "$COUNT" -lt 50 ]; then LEVEL="Lv.4 í™”ì´íŠ¸ í•´ì»¤"; COLOR="purple";
          else LEVEL="Lv.5 ì •ë³´ë³´ì•ˆ ë§ˆìŠ¤í„°"; COLOR="red"; fi
          
          echo "LEVEL_BADGE=https://img.shields.io/badge/Level-$LEVEL-$COLOR?style=for-the-badge" >> $GITHUB_OUTPUT

      # 3. [ê¸°ëŠ¥] ì˜¤ëŠ˜ì˜ ë³´ì•ˆ ìš©ì–´ (ëœë¤ ìƒì„±)
      - name: ğŸ² Generate Daily Security Tip
        id: tip
        shell: bash
        run: |
          TIPS=("Zero Trust: ì•„ë¬´ë„ ì‹ ë¢°í•˜ì§€ ì•Šê³  í•­ìƒ ê²€ì¦í•˜ë¼." "CIA Triad: ê¸°ë°€ì„±, ë¬´ê²°ì„±, ê°€ìš©ì„±ì€ ë³´ì•ˆì˜ 3ëŒ€ ìš”ì†Œë‹¤." "SQL Injection: ì…ë ¥ê°’ ê²€ì¦ ì‹¤íŒ¨ë¡œ ë°œìƒí•˜ëŠ” DB í•´í‚¹ ê¸°ë²•." "Ransomware: ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•˜ê³  ëª¸ê°’ì„ ìš”êµ¬í•˜ëŠ” ì•…ì„±ì½”ë“œ." "Social Engineering: ì‚¬ëŒì˜ ì‹¬ë¦¬ë¥¼ ì´ìš©í•´ ì •ë³´ë¥¼ íƒˆì·¨í•˜ëŠ” ê¸°ë²•." "DDos: ë¶„ì‚°ëœ ì¢€ë¹„ PCë¡œ ì„œë¹„ìŠ¤ ê°€ìš©ì„±ì„ ë§ˆë¹„ì‹œí‚¤ëŠ” ê³µê²©.")
          RANDOM_TIP=${TIPS[$RANDOM % ${#TIPS[@]}]}
          echo "TODAY_TIP=$RANDOM_TIP" >> $GITHUB_OUTPUT

      # 4. [ë©”ì¸] README.md ìƒì„±
      - name: ğŸ“ Generate Dynamic README
        shell: bash
        run: |
          cat <<EOF > README.md
          # ğŸ›¡ï¸ ì •ë³´ë³´ì•ˆê¸°ì‚¬ ìŠ¤í„°ë”” (Information Security Engineer)
          
          ![Status](https://img.shields.io/badge/Status-Active-success?style=for-the-badge)
          ![Security Audit](${ { steps.visibility.outputs.STATUS == 'Private (Secure)' && 'https://img.shields.io/badge/Security-Secure-blue?style=for-the-badge' || 'https://img.shields.io/badge/Security-Warning-red?style=for-the-badge' } })
          ![Last Update](https://img.shields.io/badge/Updated-$(date +'%Y--%m--%d')-lightgrey?style=for-the-badge)
          ![Level](${{ steps.stats.outputs.LEVEL_BADGE }})
          
          > ğŸ’¡ **Today's Security Term:** > **${{ steps.tip.outputs.TODAY_TIP }}**
          
          ---
          
          ## ğŸ“‚ í•™ìŠµ í˜„í™© (Study Dashboard)
          í˜„ì¬ê¹Œì§€ **${{ steps.stats.outputs.REPORT_COUNT }}**ê°œì˜ í•™ìŠµ ë³´ê³ ì„œê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
          
          ### ğŸ“š í•™ìŠµ ì»¤ë¦¬í˜ëŸ¼ (ìƒì„¸ ë³´ê¸°)
          <details>
          <summary>ğŸ‘† **1. ì‹œìŠ¤í…œ ë³´ì•ˆ (System Security) - í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸°**</summary>
          
          - **ìš´ì˜ì²´ì œ êµ¬ì¡°:** CPU/ë©”ëª¨ë¦¬ ê´€ë¦¬, í”„ë¡œì„¸ìŠ¤ ìŠ¤ì¼€ì¤„ë§, êµì°©ìƒíƒœ(Deadlock)
          - **í´ë¼ì´ì–¸íŠ¸ ë³´ì•ˆ:** ìœˆë„ìš° ë ˆì§€ìŠ¤íŠ¸ë¦¬, ì•…ì„±ì½”ë“œ(ë°”ì´ëŸ¬ìŠ¤/ëœì„¬ì›¨ì–´) ë¶„ì„ ë° ëŒ€ì‘
          - **ì„œë²„ ë³´ì•ˆ:** ê³„ì • ê´€ë¦¬(/etc/passwd), ê¶Œí•œ ê´€ë¦¬(chmod), ì„œë¹„ìŠ¤ ë³´ì•ˆ
          - **ë¡œê·¸ ë¶„ì„:** Syslog, wtmp/utmp, Windows Event Log, ì¹¨í•´ì‚¬ê³  ëŒ€ì‘
          </details>

          <details>
          <summary>ğŸ‘† **2. ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ (Network Security)**</summary>
          
          - **ë„¤íŠ¸ì›Œí¬ ì¼ë°˜:** OSI 7ê³„ì¸µ, TCP/IP í—¤ë” êµ¬ì¡°
          - **ê³µê²© ê¸°ë²•:** DoS/DDoS, Spoofing, Sniffing, Session Hijacking
          - **ë³´ì•ˆ ì¥ë¹„:** ë°©í™”ë²½, IDS/IPS, VPN, NAC
          - **ë¬´ì„  ë³´ì•ˆ:** WEP, WPA/WPA2, 802.1x
          </details>

          <details>
          <summary>ğŸ‘† **3. ì–´í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ (App Security)**</summary>
          
          - **ì›¹ ë³´ì•ˆ:** OWASP Top 10 (SQL Injection, XSS, CSRF)
          - **DB ë³´ì•ˆ:** ì ‘ê·¼í†µì œ, ë¬´ê²°ì„±, ì•”í˜¸í™”
          - **ì „ììƒê±°ë˜:** SET, SSL/TLS í”„ë¡œí† ì½œ
          </details>

          <details>
          <summary>ğŸ‘† **4. ì •ë³´ë³´ì•ˆ ì¼ë°˜ (General)**</summary>
          
          - **ë³´ì•ˆ ê°œìš”:** ê¸°ë°€ì„±, ë¬´ê²°ì„±, ê°€ìš©ì„± (CIA)
          - **ì•”í˜¸í•™:** ëŒ€ì¹­í‚¤/ê³µê°œí‚¤, í•´ì‹œí•¨ìˆ˜, ì „ìì„œëª…, PKI
          - **ì ‘ê·¼ í†µì œ:** MAC, DAC, RBAC, ì‹ë³„/ì¸ì¦/ì¸ê°€
          </details>

          <details>
          <summary>ğŸ‘† **5. ê´€ë¦¬ ë° ë²•ê·œ (Compliance)**</summary>
          
          - **ê´€ë¦¬ì²´ê³„:** ISMS-P, ìœ„í—˜ ê´€ë¦¬(Risk Management), BCP/DRP
          - **ë²•ê·œ:** ì •ë³´í†µì‹ ë§ë²•, ê°œì¸ì •ë³´ë³´í˜¸ë²•, ì •ë³´í†µì‹ ê¸°ë°˜ë³´í˜¸ë²•
          </details>
          
          ---
          
          ## ğŸ“‘ í•™ìŠµ ë¦¬í¬íŠ¸ ëª©ë¡ (Reports)
          | ë‚ ì§œ | ë¦¬í¬íŠ¸ ì œëª© | ìƒíƒœ |
          |:---:|:---|:---:|
          EOF
          
          # ë¦¬í¬íŠ¸ ëª©ë¡ ìƒì„± (ì•ˆì •ì„± ê°•í™”)
          if [ -d "reports" ] && ls reports/*.md >/dev/null 2>&1; then
            ls -1t reports/*.md | while read filepath; do
              filename=$(basename "$filepath")
              dateStr=$(echo "$filename" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' || date +'%Y-%m-%d')
              echo "| $dateStr | [$filename]($filepath) | âœ… Verified |" >> README.md
            done
          else
            echo "| - | ğŸ“ ì‘ì„±ëœ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. | - |" >> README.md
          fi
          
          echo -e "\n---\n*Auto-generated by GitHub Actions (Ultimate Edition)*" >> README.md

      # 5. [ë³´ì•ˆ] DLP ìŠ¤ìº” ë° ë§ˆìŠ¤í‚¹ (ë¯¼ê° ì •ë³´ ìë™ ê°€ë¦¼)
      - name: ğŸ›¡ï¸ Security Guardrail - DLP Masking
        run: |
          KEYWORDS=("PRIVATE KEY" "AWS_ACCESS_KEY" "password=" "secret")
          for KEY in "${KEYWORDS[@]}"; do
            sed -i "s/$KEY/[REDACTED-SECRET]/g" README.md
          done

      - name: Commit and Push
        run: |
          git config --global user.name "security-bot"
          git config --global user.email "bot@noreply.github.com"
          git add README.md
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update Blog: Level ${{ steps.stats.outputs.REPORT_COUNT }} (Sec Audit: ${{ steps.visibility.outputs.STATUS }})"
            git push
          fi
