name: CI/CD - Information Server Setup and Deployment (V3)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ====================================================================
  # 1. CI (ì§€ì†ì  í†µí•©) - ë¹Œë“œ ë° ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„
  # ====================================================================
  ci_build:
    runs-on: ubuntu-latest
    
    # ğŸ“ ì‘ì—… ë””ë ‰í† ë¦¬ êµ¬ì¡° ê°€ì •:
    # study/
    # â”œâ”€â”€ .github/
    # â”œâ”€â”€ python-server/
    # â”œâ”€â”€ spring-boot-app/
    # â”‚   â””â”€â”€ pom.xml  <-- ì´ íŒŒì¼ì´ setup-javaì—ì„œ ìš”êµ¬ë¨
    # â””â”€â”€ deploy.yml

    steps:
      - name: ğŸ“¦ ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ (í•„ìˆ˜)
        uses: actions/checkout@v4
        # ë ˆí¬ì§€í† ë¦¬ íŒŒì¼ì´ /home/runner/work/study/study ê²½ë¡œì— ë³µì‚¬ë¨

      # --- ğŸ Python í™˜ê²½ ì„¤ì • ---
      # ... (ì´ì „ê³¼ ë™ì¼) ...
      - name: ğŸ Python 3.11 ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: ğŸ Python ì„œë²„ ì¢…ì†ì„± ì„¤ì¹˜
        run: |
          echo "Installing Python dependencies..."
          # cd ./python-server 
          # pip install -r requirements.txt
          echo "Python í™˜ê²½ ì„¤ì • ì™„ë£Œ"

      # --- â˜• Java/Spring Boot í™˜ê²½ ì„¤ì • (pom.xml ì˜¤ë¥˜ í•´ê²°) ---
      - name: â˜• Java 17 ë° Maven ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven
          java-package: jdk
          check-latest: false
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: ${{ secrets.GITHUB_TOKEN }} 
          overwrite-settings: true
          # âœ… ì˜¤ë¥˜ í•´ê²°: spring-boot-app ë””ë ‰í† ë¦¬ì˜ pom.xml ê²½ë¡œë¥¼ ëª…ì‹œ
          cache-dependency-path: 'spring-boot-app/pom.xml' 

      - name: â˜• Spring Boot ë¹Œë“œ (JAR íŒŒì¼ ìƒì„±)
        run: |
          echo "Building Spring Boot application..."
          # cd ./spring-boot-app ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ ë¹Œë“œ
          cd spring-boot-app
          # íƒ€ê²Ÿ íŒŒì¼(JAR)ì´ './target/'ì— ìƒì„±ë¨
          # mvn clean install -DskipTests
          echo "Spring Boot ë¹Œë“œ ì™„ë£Œ: íƒ€ê²Ÿ íŒŒì¼(JAR) ìƒì„±ë¨"
          
      # --- ğŸ“ ë””ë ‰í† ë¦¬ ë° íŒŒì¼/ë¦¬ì†ŒìŠ¤ ìƒì„± ---
      - name: ğŸ“ ë””ë ‰í† ë¦¬ ë° íŒŒì¼/ë¦¬ì†ŒìŠ¤ ìƒì„±
        run: |
          # 1. ì•„í‹°íŒ©íŠ¸ ì €ì¥ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ./artifacts/config/data-collector
          
          # 2. ì •ë³´ìˆ˜ì§‘ì„œë²„ ì„¤ì¹˜ ì •ë³´ íŒŒì¼ ìƒì„±
          echo "Server Type: Python, Java/Spring Boot" > ./artifacts/server_install_info.txt
          
          # 3. ë¦¬ì†ŒìŠ¤ ì •ë³´ íŒŒì¼ ìƒì„±
          echo "Service Resource A: Enabled" > ./artifacts/config/data-collector/resource.conf
          
          # 4. í™ˆí˜ì´ì§€ ì„¤ì¹˜ íŒŒì¼ (ì´ˆê¸° ë²„ì „) ìƒì„±
          echo "<html><body><h1>[WIP] Initial Homepage Setup</h1></body></html>" > ./artifacts/index.html
          
          echo "íŒŒì¼, ë””ë ‰í† ë¦¬, ë¦¬ì†ŒìŠ¤ ìƒì„± ì™„ë£Œ"
          
      # --- ğŸ“¤ ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (íƒ€ê²Ÿ íŒŒì¼ í¬í•¨) ---
      - name: ğŸ“¤ ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (ë°°í¬ Jobì—ì„œ ì‚¬ìš©)
        uses: actions/upload-artifact@v4
        with:
          name: server-deployment-package
          path: |
            ./artifacts/
            ./spring-boot-app/target/*.jar # âœ… ë¹Œë“œëœ JAR íƒ€ê²Ÿ íŒŒì¼ ì¶”ê°€

  # ====================================================================
  # 2. CD (ì§€ì†ì  ë°°í¬) - ì¸í”„ë¼ ì„¤ì • ë° ë°°í¬, ìœ íš¨ì„± ê²€ì¦
  # ====================================================================
  cd_deploy:
    needs: ci_build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: server-deployment-package
          path: ./deploy-package

      # --- ğŸ›¡ï¸ ë°©í™”ë²½ ë° ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ìƒì„±/ì„¤ì • (í´ë¼ìš°ë“œ í™˜ê²½ ê°€ì •) ---
      - name: ğŸŒ ì¸í”„ë¼ í”„ë¡œë¹„ì €ë‹ (ë°©í™”ë²½, ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´)
        run: |
          # ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ë° ë°©í™”ë²½ ê·œì¹™ íŒŒì¼ ìƒì„±
          echo "Virtual Network: VNet-Collector, Subnet: SNet-App" > ./deploy-package/network_info_final.txt
          echo "Firewall Rule: Allow SSH (Port 22), Allow HTTP (Port 80)" >> ./deploy-package/network_info_final.txt
          echo "ë°©í™”ë²½/ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ìƒì„± ë‹¨ê³„ ì™„ë£Œ"

      # --- ğŸ’» ì„œë²„ ë°°í¬ ë° í™ˆí˜ì´ì§€ ì„¤ì¹˜ ---
      - name: ğŸ’» ì„œë²„ì— ë°°í¬ (SSH/SCP ì‚¬ìš© ì˜ˆì‹œ)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          source: "./deploy-package/*"
          target: "/var/www/data-server/" 
          
      # --- âœ… ì •ë³´ ì •í™•ì„± ë° ë„¤íŠ¸ì›Œí¬ ìœ íš¨ì„± ê²€ì¦ ---
      - name: âœ… ìƒì„±ëœ ì •ë³´ ì •í™•ì„± ê²€ì¦ (íŒŒì¼ ë‚´ìš© í™•ì¸)
        run: |
          echo "--- ìƒì„±ëœ ë„¤íŠ¸ì›Œí¬ ì •ë³´ íŒŒì¼ ë‚´ìš© ---"
          cat ./deploy-package/network_info_final.txt
          
          # íŒŒì¼ ë‚´ë¶€ì— 'Virtual Network' ì •ë³´ê°€ ì •í™•íˆ ìˆëŠ”ì§€ í™•ì¸
          if grep -q "Virtual Network: VNet-Collector" ./deploy-package/network_info_final.txt; then
            echo "âœ… ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ìƒì„± í™•ì¸."
          else
            echo "âŒ ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ê²€ì¦ ì‹¤íŒ¨."
            exit 1
          fi

      - name: ğŸ“¶ Ping í…ŒìŠ¤íŠ¸ (ì •ë³´ ì •í™•ì„± í™•ì¸)
        # ë°°í¬ëœ ì„œë²„ì˜ ì‹¤ì œ IPë‚˜ ë„ë©”ì¸ ì£¼ì†Œë¡œ ë³€ê²½
        run: |
          TARGET_HOST="${{ secrets.DEPLOY_HOST_IP_OR_DOMAIN }}" 
          echo "Testing connectivity to $TARGET_HOST..."
          
          if ping -c 4 $TARGET_HOST; then
            echo "âœ… Ping í…ŒìŠ¤íŠ¸ ì„±ê³µ: ì •ë³´ ì •í™•í•˜ê²Œ ìƒì„± ë° ë°°í¬ í›„ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸."
          else
            echo "âŒ Ping í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬/ë°©í™”ë²½ ë¬¸ì œ í™•ì¸ í•„ìš”."
          fi
