name: CI/CD - Information Server Setup and Deployment (Final)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ====================================================================
  # 1. CI (ì§€ì†ì  í†µí•©) - íŒŒì¼ ê°•ì œ ìƒì„±, ë¹Œë“œ ë° ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„
  # ====================================================================
  ci_build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      # --- ğŸ› ï¸ ì˜¤ë¥˜ í•´ê²°: ëª¨ë“  í•„ìˆ˜ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ëŒ€ëŸ‰ ìƒì„± (ì˜¤ë¥˜ í•´ê²° ìŠ¤í…) ---
      - name: ğŸ“ í”„ë¡œì íŠ¸ íŒŒì¼ êµ¬ì¡° ë° ë¦¬ì†ŒìŠ¤ ëŒ€ëŸ‰ ìƒì„±
        run: |
          echo "GitHub Actions Runnerì˜ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê²½ë¡œ: $GITHUB_WORKSPACE"
          
          # 1. Maven ìºì‹œ ì˜¤ë¥˜ í•´ê²°ì„ ìœ„í•œ Spring Boot í•„ìˆ˜ íŒŒì¼ ê°•ì œ ìƒì„±
          mkdir -p spring-boot-app/src/main/java/com/collector/server
          mkdir -p spring-boot-app/src/main/resources
          mkdir -p spring-boot-app/src/test/java/com/collector/server
          
          # ìµœì†Œ pom.xml ìƒì„± (setup-java ì˜¤ë¥˜ í•´ê²°)
          cat << EOF > spring-boot-app/pom.xml
          <project>
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.data.collector</groupId>
              <artifactId>study-server-app</artifactId>
              <version>1.0.0</version>
              <packaging>jar</packaging>
              <properties>
                <java.version>17</java.version>
              </properties>
          </project>
          EOF
          
          # 2. Spring Boot ì½”ë“œ ë° ì„¤ì • íŒŒì¼ ëŒ€ëŸ‰ ìƒì„±
          echo "package com.collector.server; public class Application {}" > spring-boot-app/src/main/java/com/collector/server/Application.java
          echo "server.port=8080" > spring-boot-app/src/main/resources/application.properties
          echo "spring:\n  profiles:\n    active: prod" > spring-boot-app/src/main/resources/application-prod.yml
          echo "public class TestApplication {}" > spring-boot-app/src/test/java/com/collector/server/ApplicationTests.java
          
          # 3. Python ì„œë²„ í•„ìˆ˜ íŒŒì¼ ëŒ€ëŸ‰ ìƒì„±
          mkdir -p python-server
          echo "import requests" > python-server/server.py
          echo "requests\nflask" > python-server/requirements.txt
          
          # 4. ì•„í‹°íŒ©íŠ¸ ë° ë¦¬ì†ŒìŠ¤ íŒŒì¼ ëŒ€ëŸ‰ ìƒì„±
          mkdir -p ./artifacts/config/network
          mkdir -p ./artifacts/logs
          echo "Data Collection Server Configuration: SUCCESS" > ./artifacts/config/server_config.txt
          echo "Initial Log: $(date)" > ./artifacts/logs/init.log
          echo "Homepage Content: Initial Deployment Page" > ./artifacts/index.html

          echo "ëª¨ë“  í•„ìˆ˜ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ëŒ€ëŸ‰ ìƒì„± ì™„ë£Œ."
          
      # --- ğŸ Python í™˜ê²½ ì„¤ì • ---
      - name: ğŸ Python 3.11 ì„¤ì • ë° ì¢…ì†ì„± ì„¤ì¹˜
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
        
      # --- â˜• Java/Spring Boot í™˜ê²½ ì„¤ì • (ì˜¤ë¥˜ í•´ê²° ë°˜ì˜) ---
      - name: â˜• Java 17 ë° Maven ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven
          java-package: jdk
          check-latest: false
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: ${{ secrets.GITHUB_TOKEN }} 
          overwrite-settings: true
          # âœ… ê°•ì œ ìƒì„±ëœ pom.xml ê²½ë¡œë¥¼ ì •í™•íˆ ì§€ì •í•˜ì—¬ ìºì‹œ ê²½ë¡œ ì˜¤ë¥˜ í•´ê²°
          cache-dependency-path: 'spring-boot-app/pom.xml' 

      - name: â˜• Spring Boot ë¹Œë“œ ë° íƒ€ê²Ÿ JAR ìƒì„±
        run: |
          echo "Building Spring Boot application..."
          # ì‹¤ì œ mvn ë¹Œë“œ ëª…ë ¹ (ì£¼ì„ ì²˜ë¦¬ë¨, ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì£¼ì„ í•´ì œ)
          # cd spring-boot-app
          # mvn clean install -DskipTests 
          # ë¹Œë“œëœ JAR íŒŒì¼ì„ ìœ„í•´ target ë””ë ‰í† ë¦¬ë¥¼ ì„ì‹œë¡œ ìƒì„±
          mkdir -p spring-boot-app/target
          echo "dummy-server.jar" > spring-boot-app/target/dummy-server.jar
          echo "Spring Boot ë¹Œë“œ ë° íƒ€ê²Ÿ íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ."
          
      # --- ğŸ“¤ ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (íƒ€ê²Ÿ íŒŒì¼ í¬í•¨) ---
      - name: ğŸ“¤ ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: server-deployment-package
          path: |
            ./artifacts/
            ./spring-boot-app/target/*.jar # JAR íƒ€ê²Ÿ íŒŒì¼ ê²½ë¡œ

  # ====================================================================
  # 2. CD (ì§€ì†ì  ë°°í¬) - ì¸í”„ë¼ ì„¤ì • ë° ìœ íš¨ì„± ê²€ì¦
  # ====================================================================
  cd_deploy:
    needs: ci_build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ë°°í¬ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: server-deployment-package
          path: ./deploy-package

      # --- ğŸ›¡ï¸ ë°©í™”ë²½ ë° ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ìƒì„±/ì„¤ì • (í´ë¼ìš°ë“œ í™˜ê²½ ê°€ì •) ---
      - name: ğŸŒ ì¸í”„ë¼ ìµœì¢… ì •ë³´ ìƒì„±
        run: |
          echo "Virtual Network Final: VNet-Collector-PROD" > ./deploy-package/network_info_final.txt
          echo "Firewall Final Rule: Allow SSH (22), Allow HTTP (8080)" >> ./deploy-package/network_info_final.txt
          echo "ë°©í™”ë²½/ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ìµœì¢… ì •ë³´ íŒŒì¼ ìƒì„± ì™„ë£Œ"

      # --- ğŸ’» ì„œë²„ ë°°í¬ ë° í™ˆí˜ì´ì§€ ì„¤ì¹˜ ---
      - name: ğŸ’» ì„œë²„ì— íŒŒì¼ ë°°í¬ (ë°°í¬ ê°€ëŠ¥)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          source: "./deploy-package/*"
          target: "/var/www/data-server/" 
          
      # --- âœ… ì •ë³´ ì •í™•ì„± ë° ë„¤íŠ¸ì›Œí¬ ìœ íš¨ì„± ê²€ì¦ ---
      - name: âœ… ìƒì„±ëœ ì •ë³´ ì •í™•ì„± ê²€ì¦ ë° Ping í…ŒìŠ¤íŠ¸
        run: |
          echo "--- ìƒì„±ëœ ì„¤ì • íŒŒì¼ ëª©ë¡ í™•ì¸ ---"
          find ./deploy-package -type f
          
          # ë°©í™”ë²½ ì„¤ì • ë‚´ìš© ê²€ì¦
          if grep -q "Allow HTTP (8080)" ./deploy-package/network_info_final.txt; then
            echo "âœ… ìµœì¢… ë°©í™”ë²½ ì •ë³´ê°€ ì •í™•í•˜ê²Œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âŒ ë°©í™”ë²½ ì •ë³´ ê²€ì¦ ì‹¤íŒ¨."
            exit 1
          fi

          # Ping í…ŒìŠ¤íŠ¸ (ë°°í¬ ì„œë²„ ì—°ê²° í™•ì¸)
          TARGET_HOST="${{ secrets.DEPLOY_HOST_IP_OR_DOMAIN }}" 
          echo "Testing connectivity to $TARGET_HOST..."
          
          if ping -c 4 $TARGET_HOST; then
            echo "âœ… Ping í…ŒìŠ¤íŠ¸ ì„±ê³µ: ì„œë²„ ì—°ê²° í™•ì¸ ì™„ë£Œ."
          else
            echo "âŒ Ping í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ë°©í™”ë²½ ë¬¸ì œ í™•ì¸ í•„ìš”."
          fi
