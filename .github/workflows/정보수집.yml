name: CI/CD - Information Server Setup and Deployment (V4 - Finalized)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ====================================================================
  # 1. CI (ì§€ì†ì  í†µí•©) - ë¹Œë“œ ë° ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„
  # ====================================================================
  ci_build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ (í•„ìˆ˜)
        uses: actions/checkout@v4
        
      # --- ğŸ› ï¸ ì˜¤ë¥˜ í•´ê²°: Spring Boot í”„ë¡œì íŠ¸ êµ¬ì¡° ê°•ì œ ìƒì„± ---
      - name: ğŸ“ Spring Boot í”„ë¡œì íŠ¸ êµ¬ì¡° ë° pom.xml ìƒì„±
        run: |
          # 1. Spring Boot ë””ë ‰í† ë¦¬ ìƒì„± (pom.xml ê²½ë¡œ í™•ë³´)
          mkdir -p spring-boot-app
          
          # 2. setup-java ì•¡ì…˜ì˜ Maven ìºì‹± ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•œ ìµœì†Œ pom.xml ìƒì„±
          cat << EOF > spring-boot-app/pom.xml
          <project>
              <modelVersion>4.0.0</modelVersion>
              <groupId>com.data.collector</groupId>
              <artifactId>study-server-app</artifactId>
              <version>1.0.0</version>
              <packaging>jar</packaging>
          </project>
          EOF
          echo "í•„ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ: spring-boot-app/pom.xml"

      # --- ğŸ Python í™˜ê²½ ì„¤ì • ---
      - name: ğŸ Python 3.11 ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: ğŸ Python ì„œë²„ ì¢…ì†ì„± ì„¤ì¹˜
        run: |
          echo "Installing Python dependencies..."
          # cd ./python-server 
          # pip install -r requirements.txt
          echo "Python í™˜ê²½ ì„¤ì • ì™„ë£Œ"

      # --- â˜• Java/Spring Boot í™˜ê²½ ì„¤ì • ---
      - name: â˜• Java 17 ë° Maven ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven
          java-package: jdk
          check-latest: false
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: ${{ secrets.GITHUB_TOKEN }} 
          overwrite-settings: true
          # âœ… ê°•ì œ ìƒì„±í•œ pom.xml íŒŒì¼ ê²½ë¡œ ì§€ì •
          cache-dependency-path: 'spring-boot-app/pom.xml' 

      - name: â˜• Spring Boot ë¹Œë“œ (íƒ€ê²Ÿ JAR ìƒì„±)
        run: |
          echo "Building Spring Boot application..."
          # ì‹¤ì œ ë¹Œë“œ ì „ì— íƒ€ê²Ÿ ë””ë ‰í† ë¦¬ ìƒì„± (ì‹¤ì œ mvn ì‹¤í–‰ ì‹œ ìƒì„±ë¨)
          mkdir -p spring-boot-app/target
          # mvn clean install -DskipTests
          echo "Spring Boot ë¹Œë“œ ëª…ë ¹ ì‹¤í–‰ ì™„ë£Œ"
          
      # --- ğŸ“ ë””ë ‰í† ë¦¬, íŒŒì¼ ë° ë¦¬ì†ŒìŠ¤ ëŒ€ëŸ‰ ìƒì„± ---
      - name: ğŸ“ ì •ë³´ ìˆ˜ì§‘ ì„œë²„ ë¦¬ì†ŒìŠ¤ ë° íŒŒì¼ ëŒ€ëŸ‰ ìƒì„±
        run: |
          # 1. ì•„í‹°íŒ©íŠ¸ ì €ì¥ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ./artifacts/config/data-collector
          mkdir -p ./artifacts/logs
          
          # 2. ì •ë³´ìˆ˜ì§‘ì„œë²„ ì„¤ì¹˜ ì •ë³´ íŒŒì¼ ìƒì„±
          echo "Server Type: Python, Java/Spring Boot" > ./artifacts/server_install_info.txt
          
          # 3. ë¡œê·¸ íŒŒì¼ ë° ë¡œê·¸ ì„¤ì • íŒŒì¼ ìƒì„±
          echo "Log level: INFO" > ./artifacts/config/log4j2.xml
          echo "Service started at $(date)" > ./artifacts/logs/startup.log
          
          # 4. ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ë° ë°©í™”ë²½ ì„¤ì • ì´ˆê¸° íŒŒì¼ ìƒì„±
          echo "VNet_Initial_Config: 10.0.0.0/16" > ./artifacts/network_config_initial.txt
          echo "Firewall_Initial_Rule: Deny_All" >> ./artifacts/network_config_initial.txt
          
          # 5. í™ˆí˜ì´ì§€ ì„¤ì¹˜ íŒŒì¼ ìƒì„±
          echo "<html><body><h1>[WIP] Initial Server Page</h1></body></html>" > ./artifacts/index.html
          
          echo "íŒŒì¼ ë° ë¦¬ì†ŒìŠ¤ ëŒ€ëŸ‰ ìƒì„± ì™„ë£Œ"
          
      # --- ğŸ“¤ ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (íƒ€ê²Ÿ íŒŒì¼ í¬í•¨) ---
      - name: ğŸ“¤ ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (ë°°í¬ Jobì—ì„œ ì‚¬ìš©)
        uses: actions/upload-artifact@v4
        with:
          name: server-deployment-package
          path: |
            ./artifacts/
            ./spring-boot-app/target/*.jar # JAR íƒ€ê²Ÿ íŒŒì¼ ê²½ë¡œ

  # ====================================================================
  # 2. CD (ì§€ì†ì  ë°°í¬) - ì¸í”„ë¼ ì„¤ì • ë° ë°°í¬, ìœ íš¨ì„± ê²€ì¦
  # ====================================================================
  cd_deploy:
    needs: ci_build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: server-deployment-package
          path: ./deploy-package

      # --- ğŸ›¡ï¸ ë°©í™”ë²½ ë° ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ìƒì„±/ì„¤ì • (ìµœì¢… ë°˜ì˜) ---
      - name: ğŸŒ ì¸í”„ë¼ í”„ë¡œë¹„ì €ë‹ ë° ìµœì¢… ì •ë³´ ìƒì„±
        run: |
          # ì´ˆê¸° íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ìµœì¢… ì„¤ì • ì •ë³´ ë°˜ì˜
          echo "Virtual Network Final: VNet-Collector-PROD" > ./deploy-package/network_info_final.txt
          echo "Firewall Final Rule: Allow SSH (22), Allow HTTP (8080)" >> ./deploy-package/network_info_final.txt
          echo "ë°©í™”ë²½/ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ìµœì¢… ì •ë³´ íŒŒì¼ ìƒì„± ì™„ë£Œ"

      # --- ğŸ’» ì„œë²„ ë°°í¬ ë° í™ˆí˜ì´ì§€ ì„¤ì¹˜ ---
      - name: ğŸ’» ì„œë²„ì— íŒŒì¼ ë°°í¬ ë° í™ˆí˜ì´ì§€ ì„¤ì¹˜
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          source: "./deploy-package/*"
          target: "/var/www/data-server/" 
          
      # --- âœ… ì •ë³´ ì •í™•ì„± ë° ë„¤íŠ¸ì›Œí¬ ìœ íš¨ì„± ê²€ì¦ ---
      - name: âœ… ìƒì„±ëœ ì •ë³´ ì •í™•ì„± ê²€ì¦ (ìµœì¢… íŒŒì¼ ë‚´ìš© í™•ì¸)
        run: |
          echo "--- ìµœì¢… ë„¤íŠ¸ì›Œí¬ ì •ë³´ íŒŒì¼ ë‚´ìš© ---"
          cat ./deploy-package/network_info_final.txt
          
          if grep -q "VNet-Collector-PROD" ./deploy-package/network_info_final.txt; then
            echo "âœ… ìµœì¢… ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ì •í™•í•˜ê²Œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âŒ ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ê²€ì¦ ì‹¤íŒ¨."
            exit 1
          fi

      - name: ğŸ“¶ Ping í…ŒìŠ¤íŠ¸ (ë°°í¬ ì„œë²„ ì—°ê²° í™•ì¸)
        run: |
          TARGET_HOST="${{ secrets.DEPLOY_HOST_IP_OR_DOMAIN }}" 
          echo "Testing connectivity to $TARGET_HOST..."
          
          if ping -c 4 $TARGET_HOST; then
            echo "âœ… Ping í…ŒìŠ¤íŠ¸ ì„±ê³µ: ì„œë²„ ì—°ê²° ë° ë°©í™”ë²½(ICMP) ì„¤ì • í™•ì¸."
          else
            echo "âŒ Ping í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ë°©í™”ë²½ ë¬¸ì œ í™•ì¸ í•„ìš”."
          fi
