name: CI/CD - Information Server Setup and Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ íŠ¸ë¦¬ê±°

jobs:
  # ====================================================================
  # 1. CI (ì§€ì†ì  í†µí•©) - ë¹Œë“œ ë° ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„
  # ====================================================================
  ci_build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # --- ğŸ Python í™˜ê²½ ì„¤ì • ---
      - name: ğŸ Python 3.11 ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: ğŸ Python ì„œë²„ ì¢…ì†ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
        # NOTE: 'python-server' ë””ë ‰í† ë¦¬ì— requirements.txtê°€ ìˆë‹¤ê³  ê°€ì •
        run: |
          echo "Installing Python dependencies..."
          # cd ./python-server 
          # pip install -r requirements.txt
          echo "Python í™˜ê²½ ì„¤ì • ë° ë¹Œë“œ/ì¤€ë¹„ ì™„ë£Œ"

      # --- â˜• Java/Spring Boot í™˜ê²½ ì„¤ì • (ì‚¬ìš©ì ìš”ì²­ ë°˜ì˜) ---
      # **ì˜¤ë¥˜ í•´ê²°**: setup-javaì—ì„œ cache: mavenì„ ì‚¬ìš©í•  ë•Œ pom.xmlì„ ì°¾ì§€ ëª»í•˜ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë¯€ë¡œ,
      # í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë˜ëŠ” ì§€ì •ëœ ê²½ë¡œì— pom.xml íŒŒì¼ì´ ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤.
      - name: â˜• Java 17 ë° Maven ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven
          java-package: jdk
          check-latest: false
          server-id: github
          server-username: GITHUB_ACTOR
          # GITHUB_TOKENì€ GitHub Actionsì—ì„œ ì œê³µí•˜ëŠ” ê¸°ë³¸ í† í°ì…ë‹ˆë‹¤.
          server-password: ${{ secrets.GITHUB_TOKEN }} 
          overwrite-settings: true 
          # cache-dependency-path: '**/pom.xml' # ë£¨íŠ¸ì— pom.xmlì´ ì—†ìœ¼ë©´ ì´ ì˜µì…˜ìœ¼ë¡œ ê²½ë¡œ ì§€ì •

      - name: â˜• Spring Boot ë¹Œë“œ (JAR íŒŒì¼ ìƒì„±)
        # NOTE: 'spring-boot-app' ë””ë ‰í† ë¦¬ì— pom.xmlì´ ìˆë‹¤ê³  ê°€ì •
        run: |
          echo "Building Spring Boot application..."
          # cd ./spring-boot-app 
          # mvn clean install -DskipTests
          echo "Spring Boot ë¹Œë“œ ì™„ë£Œ: JAR íŒŒì¼ ìƒì„±ë¨"
          
      # --- ğŸ“ íŒŒì¼/ë””ë ‰í† ë¦¬/ë¦¬ì†ŒìŠ¤ ìƒì„± ---
      - name: ğŸ“ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„±
        run: |
          # 1. ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ./artifacts/config/data-collector
          
          # 2. íŒŒì¼ ìƒì„± (ì •ë³´ìˆ˜ì§‘ì„œë²„ ì„¤ì¹˜ ì •ë³´)
          echo "Server Type: Python, Java/Spring Boot" > ./artifacts/server_install_info.txt
          echo "Installation Date: $(date +%Y-%m-%d %H:%M:%S)" >> ./artifacts/server_install_info.txt
          
          # 3. ë¦¬ì†ŒìŠ¤ ì •ë³´ ìƒì„±
          echo "Service Resource A: Enabled" > ./artifacts/config/data-collector/resource.conf
          echo "íŒŒì¼, ë””ë ‰í† ë¦¬, ë¦¬ì†ŒìŠ¤ ìƒì„± ì™„ë£Œ"
          
      # --- ğŸ“¤ ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ ---
      - name: ğŸ“¤ ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (ë°°í¬ Jobì—ì„œ ì‚¬ìš©)
        uses: actions/upload-artifact@v4
        with:
          name: server-deployment-package
          path: |
            ./artifacts/
            # spring-boot-app/target/*.jar # ì‹¤ì œ JAR íŒŒì¼ ê²½ë¡œ ì¶”ê°€

  # ====================================================================
  # 2. CD (ì§€ì†ì  ë°°í¬) - ì¸í”„ë¼ ì„¤ì • ë° ë°°í¬, ìœ íš¨ì„± ê²€ì¦
  # ====================================================================
  cd_deploy:
    needs: ci_build # ë¹Œë“œ Jobì´ ì„±ê³µí•œ í›„ì— ì‹¤í–‰
    runs-on: ubuntu-latest
    
    # âš ï¸ í™˜ê²½ ë³´í˜¸ ê·œì¹™ì´ ì„¤ì •ëœ ê²½ìš° 'environment'ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
    # environment: production

    steps:
      - name: ğŸ“¥ ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: server-deployment-package
          path: ./deploy-package

      # --- ğŸ›¡ï¸ ë°©í™”ë²½ ë° ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ìƒì„±/ì„¤ì • (í´ë¼ìš°ë“œ í™˜ê²½ ê°€ì •) ---
      # **ì°¸ê³ **: ì‹¤ì œ í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ ë¦¬ì†ŒìŠ¤ ìƒì„±ì„ ìœ„í•œ Placeholder (Azure CLI ì˜ˆì‹œ)
      - name: ğŸŒ ì¸í”„ë¼ í”„ë¡œë¹„ì €ë‹ (ë°©í™”ë²½, ê°€ìƒ ë„¤íŠ¸ì›Œí¬)
        run: |
          # 1. ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ìƒì„±/ì„¤ì • (ì‹œë®¬ë ˆì´ì…˜)
          echo "Virtual Network: VNet-Collector-EastAsia, Subnet: SNet-App" > ./deploy-package/network_info_final.txt
          
          # 2. ë°©í™”ë²½ ê·œì¹™ ìƒì„±/ì„¤ì • (ì‹œë®¬ë ˆì´ì…˜)
          echo "Firewall Rule: Allow SSH (Port 22), Allow HTTP (Port 80)" >> ./deploy-package/network_info_final.txt
          
          # **ì‹¤ì œ Azure CLI ì‚¬ìš© ì˜ˆì‹œ (Secrets í•„ìš”):**
          # uses: azure/login@v1
          #   with:
          #     creds: ${{ secrets.AZURE_CREDENTIALS }}
          # run: |
          #   az network vnet create ...
          #   az network nsg rule create ...
          echo "ë°©í™”ë²½/ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ìƒì„± ë‹¨ê³„ ì™„ë£Œ"

      # --- ğŸ’» ì„œë²„ ë°°í¬ ë° í™ˆí˜ì´ì§€ ì„¤ì¹˜ ---
      - name: ğŸ’» ì„œë²„ì— ë°°í¬ (SSH/SCP ì‚¬ìš© ì˜ˆì‹œ)
        # **ì‹¤ì œ ë°°í¬**: SSH ìê²© ì¦ëª…ì„ Secretsì— ì €ì¥í•˜ê³  ssh-action ë“±ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        uses: appleboy/scp-action@v0.1.7 # ì˜ˆì‹œ ì•¡ì…˜
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          source: "./deploy-package/*"
          target: "/var/www/data-server/" # ì„œë²„ ë°°í¬ ê²½ë¡œ
          
      - name: ğŸŒ í™ˆí˜ì´ì§€ íŒŒì¼ ìƒì„± ë° ë°°í¬
        run: |
          # ì›¹ ì„œë²„ ë£¨íŠ¸ì— index.html íŒŒì¼ ìƒì„± (ë°°í¬ëœ ì„œë²„ ê²½ë¡œì— ë§ì¶° ì¡°ì •)
          echo "<html><body><h1>[OK] Information Server is Online!</h1><h2>Deployment Date: $(date)</h2></body></html>" > ./deploy-package/index.html
          # ë°°í¬ëœ ì„œë²„ì—ì„œ í•´ë‹¹ íŒŒì¼ì„ ì›¹ ë£¨íŠ¸ë¡œ ì´ë™í•˜ëŠ” ëª…ë ¹ì–´ ì‹¤í–‰ (SSH í•„ìš”)
          echo "í™ˆí˜ì´ì§€ íŒŒì¼ ìƒì„± ë° ë°°í¬ ì™„ë£Œ"

      # --- âœ… ì •ë³´ ì •í™•ì„± ë° ë„¤íŠ¸ì›Œí¬ ìœ íš¨ì„± ê²€ì¦ ---
      - name: âœ… ìƒì„±ëœ ì •ë³´ ì •í™•ì„± ê²€ì¦ (íŒŒì¼ ë‚´ìš© í™•ì¸)
        run: |
          echo "--- Server Installation Info Check ---"
          cat ./deploy-package/server_install_info.txt
          
          echo "--- Network Info Check ---"
          cat ./deploy-package/network_info_final.txt
          
          if grep -q "Allow HTTP (Port 80)" ./deploy-package/network_info_final.txt; then
            echo "âœ… ë°©í™”ë²½(HTTP) ì •ë³´ê°€ ì •í™•í•˜ê²Œ ìƒì„±/ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âŒ ë°©í™”ë²½ ì •ë³´ ê²€ì¦ ì‹¤íŒ¨."
            exit 1
          fi

      - name: ğŸ“¶ Ping ë° ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
        # **ì°¸ê³ **: ë°°í¬ëœ ì„œë²„ì˜ ì‹¤ì œ IPë‚˜ ë„ë©”ì¸ ì£¼ì†Œë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
        run: |
          TARGET_HOST="${{ secrets.DEPLOY_HOST_IP_OR_DOMAIN }}" # ë°°í¬ëœ ì„œë²„ ì£¼ì†Œ
          echo "Testing connectivity to $TARGET_HOST..."
          
          # -c 4: 4ë²ˆì˜ í•‘ í…ŒìŠ¤íŠ¸
          if ping -c 4 $TARGET_HOST; then
            echo "âœ… $TARGET_HOST ë¡œì˜ Ping í…ŒìŠ¤íŠ¸ ì„±ê³µ. ì„œë²„ ì—°ê²° í™•ì¸."
          else
            echo "âŒ $TARGET_HOST ë¡œì˜ Ping í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ë°©í™”ë²½ ë¬¸ì œ í™•ì¸ í•„ìš”."
            # exit 1 # ë„¤íŠ¸ì›Œí¬ ë¬¸ì œê°€ ë°°í¬ ì‹¤íŒ¨ë¥¼ ì˜ë¯¸í•˜ëŠ” ê²½ìš° ì£¼ì„ í•´ì œ
          fi
