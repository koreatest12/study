name: Information Server Setup and Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í™œì„±í™”

jobs:
  # 1. í™˜ê²½ ì„¤ì • ë° ì½”ë“œ ë¹Œë“œ (Python & Java/Spring Boot)
  setup_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # --- ğŸ Python í™˜ê²½ ì„¤ì • ---
      - name: ğŸ Python 3.11 ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ Python í”„ë¡œì íŠ¸ ì¢…ì†ì„± ì„¤ì¹˜ (ì˜ˆì‹œ)
        run: |
          # Python ì„œë²„ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
          # cd ./python-data-collector
          # pip install -r requirements.txt
          echo "Python í™˜ê²½ ì„¤ì • ì™„ë£Œ"
          
      # --- â˜• Java/Spring Boot í™˜ê²½ ì„¤ì • ---
      - name: â˜• Java 17 ë° Maven ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: â˜• Spring Boot ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ (Maven ì‚¬ìš© ì˜ˆì‹œ)
        run: |
          # Spring Boot í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (í•„ìš”ì‹œ)
          # cd ./spring-boot-server
          # mvn clean install -DskipTests
          echo "Spring Boot ë¹Œë“œ ì™„ë£Œ"

      # 2. íŒŒì¼ ì‹œìŠ¤í…œ ë° ë¦¬ì†ŒìŠ¤ ì¤€ë¹„
      - name: ğŸ“ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ìƒì„± (Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰)
        # GitHub Actions Runnerì—ì„œ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„±
        run: |
          mkdir -p ./build-artifacts/config/data-collector
          echo "Data Collection Server Config" > ./build-artifacts/config/data-collector/server.conf
          echo "Build-Artifact-File-$(date +%Y%m%d%H%M%S)" > ./build-artifacts/resource_info.txt
          echo "íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ"

      # 3. ë¹Œë“œ ê²°ê³¼ë¬¼ ì €ì¥
      - name: ğŸ“¤ ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (ë°°í¬ Jobì—ì„œ ì‚¬ìš©)
        uses: actions/upload-artifact@v4
        with:
          name: server-build-artifacts
          path: |
            ./build-artifacts
            # Spring Boot JAR íŒŒì¼ ê²½ë¡œ (ì˜ˆì‹œ: ./spring-boot-server/target/*.jar)

  # 4. ì¸í”„ë¼ í”„ë¡œë¹„ì €ë‹ ë° í…ŒìŠ¤íŠ¸ (ë°°í¬ Job)
  deployment_and_validation:
    needs: setup_and_build # ë¹Œë“œ Jobì´ ì„±ê³µí•œ í›„ì— ì‹¤í–‰
    runs-on: ubuntu-latest
    # **ì°¸ê³ **: ì‹¤ì œ ë°©í™”ë²½/ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ìƒì„±ì€
    # AWS, Azure, GCP ë“± í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ í•´ë‹¹ CLI/Actionì„ í†µí•´ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
    # ì•„ë˜ëŠ” í•´ë‹¹ ë‹¨ê³„ë¥¼ 'ì‹œë®¬ë ˆì´ì…˜'í•˜ê±°ë‚˜ í´ë¼ìš°ë“œ CLIë¥¼ ì‚¬ìš©í•˜ëŠ” 'ì˜ˆì‹œ'ì…ë‹ˆë‹¤.
    
    steps:
      - name: ğŸ“¥ ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: server-build-artifacts
          path: ./downloaded-artifacts

      # --- ğŸŒ í´ë¼ìš°ë“œ ì¸í”„ë¼ ì‘ì—… (ì˜ˆì‹œ: Azure CLI ì‚¬ìš©) ---
      - name: ğŸŒ Azure CLI ì„¤ì¹˜ ë° ë¡œê·¸ì¸ (í•„ìš”ì‹œ)
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }} # GitHub Secretì— ì €ì¥ëœ ìê²© ì¦ëª… ì‚¬ìš©

      - name: ğŸ›¡ï¸ ë°©í™”ë²½ ë° ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ìƒì„± (ì‹œë®¬ë ˆì´ì…˜ ë° CLI ì‚¬ìš© ì˜ˆì‹œ)
        run: |
          echo "Azure Resource Group: RG-DataCollector" > ./downloaded-artifacts/network_info.txt
          echo "Virtual Network: VNet-Collector-EastAsia" >> ./downloaded-artifacts/network_info.txt
          
          # ì‹¤ì œ Azure CLI ëª…ë ¹ì–´ ì˜ˆì‹œ (í•„ìš”ì— ë”°ë¼ ë³€ê²½)
          # az network vnet create --resource-group RG-DataCollector --name VNet-Collector-EastAsia --address-prefix 10.0.0.0/16
          # az network nsg rule create --resource-group RG-DataCollector --nsg-name NSG-Collector --name Allow-HTTP --protocol Tcp --direction Inbound --source-address-prefix Internet --source-port-range '*' --destination-address-prefix '*' --destination-port-range 80 --priority 100 --access Allow
          echo "ë°©í™”ë²½/ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ìƒì„± ë‹¨ê³„ ì™„ë£Œ"

      # --- ğŸ’» ì„œë²„ ë°°í¬ ë° í™ˆí˜ì´ì§€ ì„¤ì • (ì˜ˆì‹œ) ---
      - name: ğŸ’» ì„œë²„ ë°°í¬ (SSH ë˜ëŠ” í´ë¼ìš°ë“œ ë°°í¬ Action ì‚¬ìš©)
        run: |
          # SCP/rsync ë˜ëŠ” AWS CodeDeploy/Azure Web App Action ë“±ì„ ì‚¬ìš©í•˜ì—¬
          # ./downloaded-artifacts/ ë‚´ì˜ íŒŒì¼ë“¤ì„ ìµœì¢… ì„œë²„ì— ë°°í¬
          echo "ì„œë²„ì— íŒŒì¼ ë° ë¦¬ì†ŒìŠ¤ ë°°í¬ ì™„ë£Œ"
          
      - name: ğŸŒ í™ˆí˜ì´ì§€ íŒŒì¼ ë°°ì¹˜ (ì˜ˆì‹œ)
        run: |
          # HTML íŒŒì¼ ìƒì„± ë° ì„œë²„ì˜ ì›¹ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— ë°°ì¹˜í•˜ëŠ” ì‘ì—… ì‹œë®¬ë ˆì´ì…˜
          echo "<html><body><h1>Data Collection Server is Running!</h1></body></html>" > ./downloaded-artifacts/index.html
          echo "í™ˆí˜ì´ì§€ íŒŒì¼ ë°°ì¹˜ ì™„ë£Œ"
      
      # --- âœ… ì •ë³´ ì •í™•ì„± ë° ë„¤íŠ¸ì›Œí¬ ìœ íš¨ì„± ê²€ì¦ ---
      - name: âœ… ìƒì„±ëœ íŒŒì¼ ì •ë³´ ê²€ì¦
        run: |
          # ì´ì „ì— ìƒì„±ëœ íŒŒì¼ ë‚´ìš©ì„ í™•ì¸í•˜ì—¬ ì •ë³´ ì •í™•ì„±ì„ ê²€ì¦
          cat ./downloaded-artifacts/network_info.txt
          if grep -q "VNet-Collector-EastAsia" ./downloaded-artifacts/network_info.txt; then
            echo "âœ… ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ì •í™•í•˜ê²Œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âŒ ê°€ìƒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ê²€ì¦ ì‹¤íŒ¨."
            exit 1
          fi

      - name: ğŸ“¶ Ping ë° ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸ (ëŒ€ìƒ IP/ë„ë©”ì¸ í•„ìš”)
        # **ì°¸ê³ **: GitHub-hosted RunnerëŠ” ì™¸ë¶€ ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ë˜ì§€ë§Œ,
        # **ì‹¤ì œ ë°°í¬ëœ ì„œë²„**ì— ì—°ê²°í•˜ë ¤ë©´ ì„œë²„ì˜ **ê³µê°œ IP/ë„ë©”ì¸**ì´ í•„ìš”í•©ë‹ˆë‹¤.
        run: |
          TARGET_HOST="google.com" # ë˜ëŠ” ë°°í¬ëœ ì„œë²„ì˜ ì‹¤ì œ IP ì£¼ì†Œ
          if ping -c 4 $TARGET_HOST; then
            echo "âœ… $TARGET_HOST ë¡œì˜ Ping í…ŒìŠ¤íŠ¸ ì„±ê³µ."
          else
            echo "âŒ $TARGET_HOST ë¡œì˜ Ping í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨."
            # ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œë¥¼ ê³„ì† ì§„í–‰í•˜ë ¤ë©´ exit 0 ì‚¬ìš© ê°€ëŠ¥
          fi
